<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encounter Balancer - D&D Custom System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="monsters.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4A49B8'
                    }
                }
            }
        }
    </script>
    <style>
        .tab-active {
            background-color: #5D5CDE;
            color: white;
        }
        .tab-inactive {
            background-color: #e5e7eb;
            color: #374151;
            transition: background-color 0.2s ease;
        }
        .tab-inactive:hover {
            background-color: #d1d5db;
        }
        .dark .tab-inactive {
            background-color: #374151;
            color: #d1d5db;
        }
        .dark .tab-inactive:hover {
            background-color: #4b5563;
        }
        .current-turn {
            border: 3px solid #10b981 !important;
            box-shadow: 0 0 15px rgba(16, 185, 129, 0.5);
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-900 dark:text-white min-h-screen">
    <div class="container mx-auto px-4 py-6 max-w-7xl">
        <h1 class="text-3xl font-bold text-center mb-8">Encounter Balancer</h1>
        
        <!-- Tab Navigation -->
        <div class="flex flex-wrap gap-2 mb-6 border-b border-gray-200 dark:border-gray-700">
            <button onclick="showTab('party')" id="tab-party" class="px-4 py-2 rounded-t-lg tab-active transition-colors">Party Builder</button>
            <button onclick="showTab('builder')" id="tab-builder" class="px-4 py-2 rounded-t-lg tab-inactive transition-colors">Monster Builder</button>
            <button onclick="showTab('monsters')" id="tab-monsters" class="px-4 py-2 rounded-t-lg tab-inactive transition-colors">Monster Library</button>
            <button onclick="showTab('encounter')" id="tab-encounter" class="px-4 py-2 rounded-t-lg tab-inactive transition-colors">Encounter Calculator</button>
        </div>

        <!-- Party Builder Tab -->
        <div id="party-tab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">Party Composition</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-2 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Party Size</label>
                            <select id="party-size" onchange="updatePartySize()" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                                <option value="1">1 Character</option>
                                <option value="2">2 Characters</option>
                                <option value="3">3 Characters</option>
                                <option value="4" selected>4 Characters</option>
                                <option value="5">5 Characters</option>
                                <option value="6">6 Characters</option>
                            </select>
                        </div>
                        <div class="flex items-end">
                            <button onclick="useDefaultParty()" class="w-full px-2 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors text-sm">Quick Fill</button>
                        </div>
                        <div class="flex items-end">
                            <button onclick="saveCurrentParty()" class="w-full px-2 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors text-sm">Save</button>
                        </div>
                        <div class="flex items-end">
                            <button onclick="loadSavedParty()" class="w-full px-2 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors text-sm">Load</button>
                        </div>
                        <div class="flex items-end">
                            <button onclick="deleteSavedParty()" class="w-full px-2 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors text-sm">Delete</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 mb-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Party Name</label>
                            <input type="text" id="party-name" placeholder="Enter party name to save..." class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Select Saved Party</label>
                            <select id="saved-parties" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                                <option value="">Select saved party...</option>
                            </select>
                        </div>
                    </div>
                    <div id="party-members"></div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">Character Builder</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Character Name</label>
                            <input type="text" id="char-name" placeholder="Enter character name" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Level (1-10)</label>
                            <input type="number" id="char-level" min="1" max="10" value="1" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Hit Points</label>
                                <input type="number" id="char-hp" min="1" max="15" value="2" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Stress</label>
                                <input type="number" id="char-stress" min="1" max="15" value="2" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Class Points</label>
                                <input type="number" id="char-class" min="1" max="15" value="2" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Spell Points</label>
                                <input type="number" id="char-spell" min="0" max="15" value="1" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Evasion</label>
                                <input type="number" id="char-evasion" min="8" max="20" value="10" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Armor Points</label>
                                <input type="number" id="char-armor" min="0" max="10" value="3" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Threshold Lower</label>
                                <input type="number" id="char-threshold-low" min="1" max="20" value="7" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Threshold Upper</label>
                                <input type="number" id="char-threshold-high" min="2" max="30" value="14" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Attack Modifier</label>
                            <input type="number" id="char-attack" min="-2" max="10" value="3" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Special Abilities</label>
                            <textarea id="char-abilities" placeholder="Describe powerful abilities, bonuses, special gear, etc." class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base h-20"></textarea>
                        </div>
                        <button onclick="addCharacterToParty()" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors">Add to Party</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monster Library Tab -->
        <div id="monsters-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">Monster Library</h2>
                    <div class="mb-4">
                        <input type="text" id="monster-search" placeholder="Search monsters..." class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base" oninput="filterMonsters()">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Filter by Tier</label>
                        <select id="tier-filter" onchange="filterMonsters()" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            <option value="">All Tiers</option>
                            <option value="1">Tier 1</option>
                            <option value="2">Tier 2</option>
                            <option value="3">Tier 3</option>
                            <option value="4">Tier 4</option>
                            <option value="5">Tier 5</option>
                        </select>
                    </div>
                    <div id="monster-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">Current Encounter</h2>
                    <div id="current-encounter" class="space-y-2 mb-4"></div>
                    <div class="flex flex-wrap gap-2 mb-4">
                        <button onclick="clearEncounter()" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">Clear Encounter</button>
                        <button onclick="saveCurrentEncounter()" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors">Save</button>
                        <button onclick="loadSavedEncounter()" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors">Load</button>
                        <button onclick="deleteSavedEncounter()" class="px-4 py-2 bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors">Delete</button>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-2">
                        <div>
                            <label class="block text-sm font-medium mb-2">Encounter Name</label>
                            <input type="text" id="encounter-name" placeholder="Enter encounter name to save..." class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Select Saved Encounter</label>
                            <select id="saved-encounters" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                                <option value="">Select saved encounter...</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Monster Builder Tab -->
        <div id="builder-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">Monster Builder</h2>
                    <div class="mb-4 p-3 bg-white dark:bg-gray-700 rounded-lg border">
                        <label class="block text-sm font-medium mb-2">Load From Library</label>
                        <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
                            <input type="text" id="builder-search" placeholder="Search library monsters..." class="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base" oninput="filterBuilderMonsters()">
                            <select id="builder-monster-select" class="p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                                <option value="">Select monster...</option>
                            </select>
                            <button onclick="loadMonsterToBuilder()" class="px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-base">Load Monster</button>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Monster Name</label>
                            <input type="text" id="monster-name" placeholder="Enter monster name" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Tier (1-5)</label>
                            <select id="monster-tier" onchange="updateMonsterGuidelines()" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                                <option value="1">Tier 1</option>
                                <option value="2">Tier 2</option>
                                <option value="3">Tier 3</option>
                                <option value="4">Tier 4</option>
                                <option value="5">Tier 5</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Hit Points</label>
                                <input type="number" id="monster-hp" min="1" max="50" value="2" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Stress</label>
                                <input type="number" id="monster-stress" min="0" max="20" value="2" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Evasion</label>
                            <input type="number" id="monster-evasion" min="8" max="25" value="12" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Threshold Lower</label>
                                <input type="number" id="monster-threshold-low" min="1" max="20" value="5" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Threshold Upper</label>
                                <input type="number" id="monster-threshold-high" min="2" max="30" value="15" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">Damage Dice</label>
                                <select id="monster-damage-dice" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                                    <option value="1d4">1d4</option>
                                    <option value="1d6" selected>1d6</option>
                                    <option value="1d8">1d8</option>
                                    <option value="1d10">1d10</option>
                                    <option value="1d12">1d12</option>
                                    <option value="2d4">2d4</option>
                                    <option value="2d6">2d6</option>
                                    <option value="2d8">2d8</option>
                                    <option value="2d10">2d10</option>
                                    <option value="3d4">3d4</option>
                                    <option value="3d6">3d6</option>
                                    <option value="3d8">3d8</option>
                                    <option value="3d10">3d10</option>
                                    <option value="4d6">4d6</option>
                                    <option value="4d8">4d8</option>
                                    <option value="4d10">4d10</option>
                                    <option value="5d6">5d6</option>
                                    <option value="5d8">5d8</option>
                                    <option value="6d6">6d6</option>
                                    <option value="6d8">6d8</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">Attack Modifier</label>
                                <input type="number" id="monster-attack" min="-2" max="15" value="2" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Special Features</label>
                            <textarea id="monster-features" placeholder="Describe special abilities, stress costs, etc." class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base h-20"></textarea>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="saveCustomMonster()" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors">Save Monster</button>
                            <button onclick="addMonsterToEncounter()" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 transition-colors">Add to Encounter</button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">Guidelines for Tier <span id="current-tier">1</span></h2>
                    <div id="tier-guidelines" class="text-sm text-gray-600 dark:text-gray-400 space-y-2"></div>
                    
                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-2">Power Estimation</h3>
                        <div id="power-estimation" class="text-sm space-y-1"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Encounter Calculator Tab -->
        <div id="encounter-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-lg">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-semibold">Encounter Setup</h2>
                        <button onclick="openInitiativeTracker()" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                            🎯 Initiative Tracker
                        </button>
                    </div>
                    <div class="mb-4">
                        <h3 class="font-semibold mb-2">Current Party (<span id="party-count">0</span> members)</h3>
                        <div id="party-summary" class="text-sm text-gray-600 dark:text-gray-400"></div>
                    </div>
                    <div class="mb-4">
                        <h3 class="font-semibold mb-2">Current Encounter</h3>
                        <div id="encounter-summary" class="text-sm text-gray-600 dark:text-gray-400"></div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Desired Difficulty</label>
                        <select id="difficulty-target" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            <option value="easy">Easy (1-2 rounds)</option>
                            <option value="average" selected>Average (3-5 rounds)</option>
                            <option value="hard">Hard (5+ rounds)</option>
                        </select>
                    </div>
                    <button onclick="calculateEncounter()" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors">Calculate Encounter Balance</button>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-800 p-6 rounded-lg">
                    <h2 class="text-xl font-semibold mb-4">Results</h2>
                    <div id="calculation-results" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Initiative Tracker Screen -->
    <div id="initiativeScreen" class="screen hidden">
        <div class="max-w-7xl mx-auto p-6">
            <div class="flex items-center justify-between mb-6">
                <h1 class="text-3xl font-bold text-gray-800 dark:text-white">🎯 Initiative Tracker</h1>
                <div class="flex items-center gap-2 md:gap-3">
                    <!-- Round Counter -->
                    <div id="round-counter" class="px-2 py-2 md:px-3 bg-gray-100 dark:bg-gray-700 text-gray-800 dark:text-gray-200 rounded border font-semibold hidden">
                        <span class="hidden md:inline">Round </span><span id="round-number">1</span>
                    </div>
                    
                    <!-- Combat Control Buttons -->
                    <div id="combat-controls" class="flex gap-2">
                        <button id="start-combat-btn" onclick="startCombat()" class="px-2 py-2 md:px-4 bg-green-600 text-white rounded hover:bg-green-700 transition-colors">
                            <span class="text-lg">▶️</span><span class="hidden md:inline ml-1">Start</span>
                        </button>
                        <button id="advance-turn-btn" onclick="advanceTurn()" class="px-2 py-2 md:px-4 bg-yellow-600 text-white rounded hover:bg-yellow-700 transition-colors hidden">
                            <span class="text-lg">⏭️</span><span class="hidden md:inline ml-1">Advance</span>
                        </button>
                        <button id="stop-combat-btn" onclick="stopCombat()" class="px-2 py-2 md:px-4 bg-red-600 text-white rounded hover:bg-red-700 transition-colors hidden">
                            <span class="text-lg">⏹️</span><span class="hidden md:inline ml-1">Stop</span>
                        </button>
                    </div>
                    
                    <button onclick="showScreen('encounterScreen')" class="px-2 py-2 md:px-4 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors">
                        <span class="text-lg">←</span><span class="hidden md:inline ml-1">Back to Encounter</span>
                    </button>
                </div>
            </div>

            <!-- Initiative List -->
            <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-3 sm:p-6">
                <!-- Desktop Header (hidden on mobile) -->                
                <div class="hidden md:grid grid-cols-10 gap-2 lg:gap-4 mb-4 text-sm font-semibold text-gray-600 dark:text-gray-300 border-b border-gray-300 dark:border-gray-600 pb-2">                          
                    <div>Initiative</div>                    
                    <div>Name</div>                    
                    <div>Evasion</div>                    
                    <div>HP</div>                    
                    <div>Stress</div>                    
                    <div>Threshold</div>                    
                    <div>Damage</div>                    
                    <div>Conditions</div>                    
                    <div colspan="2">Actions</div>                
                </div>
                
                <div id="initiativeList" class="space-y-2">
                    <!-- Initiative entries will be populated here -->
                </div>
                
                <div class="mt-6 flex flex-wrap gap-4">
                    <button onclick="rollInitiativeForAll()" class="px-4 py-2 bg-purple-600 text-white rounded hover:bg-purple-700 transition-colors">
                        🎲 Roll Initiative for All
                    </button>
                    <button onclick="resetInitiative()" class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 transition-colors">
                        Reset All Initiative
                    </button>
                    <button onclick="clearAllConditions()" class="px-4 py-2 bg-yellow-600 text-white rounded hover:bg-yellow-700 transition-colors">
                        Clear All Conditions
                    </button>
                    <button onclick="addCustomEntry()" class="px-4 py-2 bg-indigo-600 text-white rounded hover:bg-indigo-700 transition-colors">
                        + Add Custom Entry
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Dark mode support
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Global state
        let party = [];
        let encounter = [];
        let customMonsters = [];

        // Pre-built monsters (updated with 10% threshold increase and tier-appropriate damage dice)


        // Tab management
        function showTab(tabName) {
            const tabs = ['party', 'monsters', 'builder', 'encounter'];
            tabs.forEach(tab => {
                const tabBtn = document.getElementById(`tab-${tab}`);
                const tabContent = document.getElementById(`${tab}-tab`);
                
                if (tab === tabName) {
                    tabBtn.className = tabBtn.className.replace('tab-inactive', 'tab-active');
                    tabContent.classList.remove('hidden');
                } else {
                    tabBtn.className = tabBtn.className.replace('tab-active', 'tab-inactive');
                    tabContent.classList.add('hidden');
                }
            });
        }

        // Party management
        function updatePartySize() {
            const size = parseInt(document.getElementById('party-size').value);
            party = party.slice(0, size);
            renderParty();
        }

        function addCharacterToParty() {
            const character = {
                name: document.getElementById('char-name').value || `Character ${party.length + 1}`,
                level: parseInt(document.getElementById('char-level').value),
                hp: parseInt(document.getElementById('char-hp').value),
                stress: parseInt(document.getElementById('char-stress').value),
                classPoints: parseInt(document.getElementById('char-class').value),
                spellPoints: parseInt(document.getElementById('char-spell').value),
                evasion: parseInt(document.getElementById('char-evasion').value),
                armor: parseInt(document.getElementById('char-armor').value),
                thresholdLow: parseInt(document.getElementById('char-threshold-low').value),
                thresholdHigh: parseInt(document.getElementById('char-threshold-high').value),
                attackMod: parseInt(document.getElementById('char-attack').value),
                abilities: document.getElementById('char-abilities').value
            };

            const maxSize = parseInt(document.getElementById('party-size').value);
            if (party.length < maxSize) {
                party.push(character);
                renderParty();
                updateEncounterSummary();
            }
        }

        function useDefaultParty() {
            const size = parseInt(document.getElementById('party-size').value);
            party = [];
            
            for (let i = 0; i < size; i++) {
                party.push(createDefaultCharacter(3, i)); // Level 3 default
            }
            renderParty();
            updateEncounterSummary();
        }

        function createDefaultCharacter(level, index) {
            return {
                name: `Character ${index + 1}`,
                level: level,
                hp: Math.min(2 + level, 10),
                stress: Math.min(2 + level, 10),
                classPoints: Math.min(2 + level, 10),
                spellPoints: Math.min(1 + level, 10),
                evasion: 10 + Math.floor(level/2),
                armor: 3,
                thresholdLow: 7 + level,
                thresholdHigh: 14 + level,
                attackMod: 3 + Math.floor(level/2)
            };
        }

        function renderParty() {
            const container = document.getElementById('party-members');
            container.innerHTML = '';
            
            party.forEach((char, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white dark:bg-gray-700 p-3 rounded border mb-2';
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="text-sm">
                            <strong>${char.name}</strong> (Level ${char.level})<br>
                            HP: ${char.hp}, Stress: ${char.stress}, Evasion: ${char.evasion}<br>
                            Threshold: ${char.thresholdLow}|${char.thresholdHigh}, Attack: +${char.attackMod}
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editCharacter(${index})" class="text-blue-500 hover:text-blue-700 text-sm" title="Edit Character">✏️</button>
                            <button onclick="removeFromParty(${index})" class="text-red-500 hover:text-red-700">×</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function removeFromParty(index) {
            party.splice(index, 1);
            renderParty();
            updateEncounterSummary();
        }

        function editCharacter(index) {
            const character = party[index];
            
            // Load character data into the Character Builder form
            document.getElementById('char-name').value = character.name;
            document.getElementById('char-level').value = character.level;
            document.getElementById('char-hp').value = character.hp;
            document.getElementById('char-stress').value = character.stress;
            document.getElementById('char-class').value = character.classPoints;
            document.getElementById('char-spell').value = character.spellPoints;
            document.getElementById('char-evasion').value = character.evasion;
            document.getElementById('char-armor').value = character.armor;
            document.getElementById('char-threshold-low').value = character.thresholdLow;
            document.getElementById('char-threshold-high').value = character.thresholdHigh;
            document.getElementById('char-attack').value = character.attackMod;
            document.getElementById('char-abilities').value = character.abilities || '';
            
            // Remove the character from the party (they'll re-add it with updates)
            party.splice(index, 1);
            renderParty();
            updateEncounterSummary();
            
            // Show confirmation message
            showCustomAlert(`${character.name} loaded into Character Builder for editing. Make your changes and click "Add to Party" to save them.`);
        }

        // Monster library
        function filterMonsters() {
            const search = document.getElementById('monster-search').value.toLowerCase();
            const tierFilter = document.getElementById('tier-filter').value;
            
            const allMonsters = [...defaultMonsters, ...customMonsters];
            const filtered = allMonsters.filter(monster => {
                const matchesSearch = monster.name.toLowerCase().includes(search);
                const matchesTier = !tierFilter || monster.tier.toString() === tierFilter;
                return matchesSearch && matchesTier;
            });
            
            renderMonsterList(filtered);
        }

        function renderMonsterList(monsters) {
            const container = document.getElementById('monster-list');
            container.innerHTML = '';
            
            monsters.forEach(monster => {
                const div = document.createElement('div');
                div.className = 'bg-white dark:bg-gray-700 p-3 rounded border';
                
                let featuresDisplay = '';
                if (monster.features && monster.features.trim().length > 0) {
                    featuresDisplay = `<div class="mt-2 text-xs text-gray-600 dark:text-gray-400 border-t pt-2"><strong>Features:</strong> ${monster.features}</div>`;
                }
                
                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="text-sm flex-1 mr-3">
                            <strong>${monster.name}</strong> (Tier ${monster.tier})<br>
                            HP: ${monster.hp}, Evasion: ${monster.evasion}, Damage: ${monster.damageDice}+${monster.attackMod}<br>
                            Threshold: ${monster.thresholdLow}|${monster.thresholdHigh}
                            ${featuresDisplay}
                        </div>
                        <div class="flex flex-col gap-1">
                            <button onclick="addMonsterToEncounter('${monster.name}')" class="px-3 py-1 bg-primary text-white rounded text-sm hover:bg-primary-dark whitespace-nowrap">Add</button>
                            <button onclick="showMonsterDetails('${monster.name}')" class="px-3 py-1 bg-blue-500 text-white rounded text-sm hover:bg-blue-600 whitespace-nowrap">Show</button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function addMonsterToEncounter(monsterName) {
            let monster;
            
            if (monsterName) {
                // Adding from library
                const allMonsters = [...defaultMonsters, ...customMonsters];
                monster = allMonsters.find(m => m.name === monsterName);
            } else {
                // Adding from builder
                monster = {
                    name: document.getElementById('monster-name').value || 'Custom Monster',
                    tier: parseInt(document.getElementById('monster-tier').value),
                    hp: parseInt(document.getElementById('monster-hp').value),
                    stress: parseInt(document.getElementById('monster-stress').value),
                    evasion: parseInt(document.getElementById('monster-evasion').value),
                    thresholdLow: parseInt(document.getElementById('monster-threshold-low').value),
                    thresholdHigh: parseInt(document.getElementById('monster-threshold-high').value),
                    damageDice: document.getElementById('monster-damage-dice').value,
                    attackMod: parseInt(document.getElementById('monster-attack').value),
                    gmTokens: parseInt(document.getElementById('monster-tokens').value),
                    features: document.getElementById('monster-features').value
                };
            }
            
            if (monster) {
                const existing = encounter.find(e => e.monster.name === monster.name);
                if (existing) {
                    existing.quantity++;
                } else {
                    encounter.push({ monster: monster, quantity: 1 });
                }
                renderCurrentEncounter();
                updateEncounterSummary();
                
                if (!monsterName) {
                    showCustomAlert(`${monster.name} added to encounter!`);
                }
            }
        }

        function renderCurrentEncounter() {
            const container = document.getElementById('current-encounter');
            container.innerHTML = '';
            
            encounter.forEach((entry, index) => {
                const div = document.createElement('div');
                div.className = 'bg-white dark:bg-gray-700 p-3 rounded border flex justify-between items-center';
                div.innerHTML = `
                    <div class="text-sm">
                        <strong>${entry.quantity}x ${entry.monster.name}</strong> (Tier ${entry.monster.tier})<br>
                        HP: ${entry.monster.hp}, Damage: ${entry.monster.damageDice}+${entry.monster.attackMod}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="changeQuantity(${index}, -1)" class="px-2 py-1 bg-red-500 text-white rounded text-sm">-</button>
                        <button onclick="changeQuantity(${index}, 1)" class="px-2 py-1 bg-green-500 text-white rounded text-sm">+</button>
                        <button onclick="removeFromEncounter(${index})" class="px-2 py-1 bg-red-600 text-white rounded text-sm">×</button>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function changeQuantity(index, delta) {
            encounter[index].quantity += delta;
            if (encounter[index].quantity <= 0) {
                encounter.splice(index, 1);
            }
            renderCurrentEncounter();
            updateEncounterSummary();
        }

        function removeFromEncounter(index) {
            encounter.splice(index, 1);
            renderCurrentEncounter();
            updateEncounterSummary();
        }

        function clearEncounter() {
            encounter = [];
            renderCurrentEncounter();
            updateEncounterSummary();
        }

        // Monster builder
        function updateMonsterGuidelines() {
            const tier = parseInt(document.getElementById('monster-tier').value);
            document.getElementById('current-tier').textContent = tier;
            
            // Auto-fill monster stats based on tier
            autoFillMonsterStats(tier);
            
            const guidelines = {
                1: {
                    hp: "1-3 HP",
                    threshold: "4|10 - 6|12",
                    evasion: "10-14",
                    damage: "1d4-1d8",
                    stress: "1-3",
                    tokens: "0-1",
                    description: "Should be roughly equal to a single level 1 character (1d6+3 ≈ 7 avg dmg) in a 1v1 fight."
                },
                2: {
                    hp: "3-6 HP",
                    threshold: "8|16 - 12|20",
                    evasion: "11-15",
                    damage: "1d6-2d4",
                    stress: "2-4",
                    tokens: "1-2",
                    description: "Should require 2 level 2-3 characters (3d6+4 ≈ 14 avg dmg)."
                },
                3: {
                    hp: "6-10 HP",
                    threshold: "15|25 - 20|30",
                    evasion: "12-16",
                    damage: "1d8-2d6",
                    stress: "3-6",
                    tokens: "2-3",
                    description: "Should require 3 level 5-6 characters (6d6+5 ≈ 26 avg dmg)."
                },
                4: {
                    hp: "10-15 HP",
                    threshold: "18|30 - 25|35",
                    evasion: "13-17",
                    damage: "2d6-3d6",
                    stress: "4-8",
                    tokens: "3-4",
                    description: "Should require 4 level 8-9 characters (6d6+6 ≈ 27 avg dmg)."
                },
                5: {
                    hp: "15-25 HP",
                    threshold: "22|35 - 30|45",
                    evasion: "14-20",
                    damage: "2d8-4d6",
                    stress: "6-12",
                    tokens: "4-6",
                    description: "Boss-level encounters requiring 4-6 level 10 characters (6d6+8 ≈ 29 avg dmg)."
                }
            };
            
            const guide = guidelines[tier];
            const container = document.getElementById('tier-guidelines');
            container.innerHTML = `
                <p><strong>Recommended Ranges:</strong></p>
                <p>• Hit Points: ${guide.hp}</p>
                <p>• Threshold: ${guide.threshold}</p>
                <p>• Evasion: ${guide.evasion}</p>
                <p>• Damage: ${guide.damage}</p>
                <p>• Stress: ${guide.stress}</p>
                <p>• GM Tokens: ${guide.tokens}</p>
                <p class="mt-2"><strong>Design Goal:</strong></p>
                <p>${guide.description}</p>
            `;
        }

        function autoFillMonsterStats(tier) {
            // Auto-fill stats based on tier (updated with tier-appropriate damage dice)
            const tierDefaults = {
                1: { hp: 2, stress: 2, evasion: 12, thresholdLow: 6, thresholdHigh: 12, damageDice: "1d6", attackMod: 2 },
                2: { hp: 4, stress: 3, evasion: 13, thresholdLow: 11, thresholdHigh: 20, damageDice: "2d6", attackMod: 3 },
                3: { hp: 8, stress: 4, evasion: 14, thresholdLow: 20, thresholdHigh: 31, damageDice: "3d6", attackMod: 5 },
                4: { hp: 12, stress: 6, evasion: 15, thresholdLow: 24, thresholdHigh: 35, damageDice: "4d6", attackMod: 6 },
                5: { hp: 20, stress: 10, evasion: 17, thresholdLow: 29, thresholdHigh: 44, damageDice: "5d6", attackMod: 8 }
            };
            
            const defaults = tierDefaults[tier];
            if (defaults) {
                document.getElementById('monster-hp').value = defaults.hp;
                document.getElementById('monster-stress').value = defaults.stress;
                document.getElementById('monster-evasion').value = defaults.evasion;
                document.getElementById('monster-threshold-low').value = defaults.thresholdLow;
                document.getElementById('monster-threshold-high').value = defaults.thresholdHigh;
                document.getElementById('monster-damage-dice').value = defaults.damageDice;
                document.getElementById('monster-attack').value = defaults.attackMod;
            }
        }

        function saveCustomMonster() {
            const monster = {
                name: document.getElementById('monster-name').value || 'Custom Monster',
                tier: parseInt(document.getElementById('monster-tier').value),
                hp: parseInt(document.getElementById('monster-hp').value),
                stress: parseInt(document.getElementById('monster-stress').value),
                evasion: parseInt(document.getElementById('monster-evasion').value),
                thresholdLow: parseInt(document.getElementById('monster-threshold-low').value),
                thresholdHigh: parseInt(document.getElementById('monster-threshold-high').value),
                damageDice: document.getElementById('monster-damage-dice').value,
                attackMod: parseInt(document.getElementById('monster-attack').value),
                features: document.getElementById('monster-features').value
            };
            
            customMonsters.push(monster);
            filterMonsters();
            
            // Show confirmation
            showCustomAlert(`${monster.name} saved to custom monsters!`);
        }

        // Encounter calculator
        function calculateEncounter() {
            if (party.length === 0) {
                showCustomAlert('Please build a party first!');
                return;
            }
            
            if (encounter.length === 0) {
                showCustomAlert('Please add monsters to the encounter!');
                return;
            }
            
            const results = simulateEncounter();
            displayResults(results);
        }

        function simulateEncounter() {
            const difficulty = document.getElementById('difficulty-target').value;
            
            // Calculate party effective level and power
            const avgLevel = party.reduce((sum, char) => sum + char.level, 0) / party.length;
            const partySize = party.length;
            
            // Base party power calculation (more linear scaling)
            let partyPower = 0;
            party.forEach(char => {
                let charPower = char.level * 20; // Base power per level
                charPower += char.hp * 8; // HP is important for survivability
                charPower += char.stress * 4; // Stress for abilities
                charPower += char.classPoints * 4; // Class abilities
                charPower += char.spellPoints * 5; // Spells are powerful
                charPower += char.attackMod * 10; // Attack modifier is crucial
                charPower += char.armor * 5; // Armor saves HP
                
                // Abilities bonus - moderate if present
                if (char.abilities && char.abilities.trim().length > 0) {
                    charPower *= 1.2; // 20% bonus for having special abilities
                }
                
                partyPower += charPower;
            });
            
            // Calculate monster power based on tier expectations
            let monsterPower = 0;
            let tierAnalysis = [];
            
            encounter.forEach(entry => {
                const monster = entry.monster;
                const tier = monster.tier;
                
                // Base power calculation for monster
                let basePower = 50; // Base monster power
                
                // Tier-based scaling (more dramatic)
                if (tier === 1) basePower = 80;
                else if (tier === 2) basePower = 180;
                else if (tier === 3) basePower = 350;
                else if (tier === 4) basePower = 650;
                else if (tier === 5) basePower = 1200;
                
                // Add stat-based power
                basePower += monster.hp * 10;
                basePower += monster.stress * 6;
                basePower += monster.attackMod * 15;
                // No longer using GM tokens - they're session-based, not monster-specific
                
                // Features/abilities multiplier
                if (monster.features && monster.features.trim().length > 0) {
                    let totalPowerBonus = 0;
                    
                    // Find all stress-based abilities and calculate power based on stress cost
                    // This regex handles HTML tags that might split the pattern
                    const stressMatches = monster.features.match(/(\d+)(?:\s*<[^>]*>\s*)*\s*Stress\s*(?:<[^>]*>\s*)*:/g) || [];
                    stressMatches.forEach(match => {
                        // Extract just the number, ignoring any HTML tags
                        const stressCost = parseInt(match.match(/(\d+)/)[1]);
                        if (stressCost === 1) {
                            totalPowerBonus += 0.25; // +25% for 1 Stress abilities
                        } else if (stressCost === 2) {
                            totalPowerBonus += 0.40; // +40% for 2 Stress abilities
                        } else if (stressCost === 3) {
                            totalPowerBonus += 0.60; // +60% for 3 Stress abilities
                        } else if (stressCost >= 4) {
                            totalPowerBonus += 0.80; // +80% for 4+ Stress abilities (very powerful)
                        }
                    });
                    
                    // Count GM Token abilities (flat +20% each)
                    const gmTokenCount = (monster.features.match(/GM Token:/g) || []).length;
                    totalPowerBonus += gmTokenCount * 0.20; // +20% per GM Token ability
                    
                    basePower *= (1 + totalPowerBonus);
                }
                
                // Calculate balance based on new tier expectations
                const expectedLevel = getTierExpectedLevel(tier);
                const expectedPartySize = getTierExpectedPartySize(tier);
                
                // Level appropriateness modifier
                const levelGap = avgLevel - expectedLevel;
                let levelMod = 1.0;
                if (levelGap < -4) levelMod = 3.5; // Much higher tier = very hard
                else if (levelGap < -2) levelMod = 2.2; // Higher tier = harder
                else if (levelGap < -1) levelMod = 1.5; // Slightly higher = bit harder
                else if (levelGap > 3) levelMod = 0.4; // Much lower tier = easy
                else if (levelGap > 1) levelMod = 0.7; // Lower tier = easier
                
                // Party size appropriateness modifier
                const sizeGap = partySize - expectedPartySize;
                let sizeMod = 1.0;
                if (sizeGap < -2) sizeMod = 1.8; // Too few characters = much harder
                else if (sizeGap < 0) sizeMod = 1.3; // Few characters = harder
                else if (sizeGap > 2) sizeMod = 0.6; // Many characters = easier
                else if (sizeGap > 0) sizeMod = 0.8; // More characters = bit easier
                
                basePower *= (levelMod * sizeMod);
                
                tierAnalysis.push({
                    tier,
                    expectedLevel,
                    expectedPartySize,
                    levelGap,
                    sizeGap,
                    levelMod,
                    sizeMod
                });
                
                monsterPower += basePower * entry.quantity;
            });
            
            const powerRatio = monsterPower / partyPower;
            
            // Determine difficulty 
            let expectedRounds, resourceUsage, winChance, difficulty_rating;
            
            if (powerRatio < 0.3) {
                expectedRounds = "1-2";
                resourceUsage = "10-20%";
                winChance = "95%+";
                difficulty_rating = "Easy";
            } else if (powerRatio < 0.7) {
                expectedRounds = "2-4";
                resourceUsage = "30-50%";
                winChance = "85-95%";
                difficulty_rating = "Average";
            } else if (powerRatio < 1.0) {
                expectedRounds = "3-5";
                resourceUsage = "50-70%";
                winChance = "70-85%";
                difficulty_rating = "Challenging";
            } else if (powerRatio < 1.5) {
                expectedRounds = "4-6";
                resourceUsage = "70-90%";
                winChance = "50-70%";
                difficulty_rating = "Hard";
            } else if (powerRatio < 2.5) {
                expectedRounds = "5-8";
                resourceUsage = "90%+";
                winChance = "25-50%";
                difficulty_rating = "Very Hard";
            } else {
                expectedRounds = "???";
                resourceUsage = "All resources + deaths";
                winChance = "5-25%";
                difficulty_rating = "Deadly";
            }
            
            return {
                powerRatio,
                expectedRounds,
                resourceUsage,
                winChance,
                difficulty_rating,
                partyPower,
                monsterPower,
                avgLevel,
                tierAnalysis
            };
        }
        
        function getTierExpectedLevel(tier) {
            const tierLevels = {
                1: 1,   // T1: 1 vs 1 Level 1 character
                2: 2.5, // T2: 1 vs 2 Level 2-3 characters
                3: 5.5, // T3: 1 vs 3 Level 5-6 characters  
                4: 8.5, // T4: 1 vs 4 Level 8-9 characters
                5: 10   // T5: 1 vs 4-6 Level 10 characters
            };
            return tierLevels[tier] || 1;
        }
        
        function getTierExpectedPartySize(tier) {
            const tierPartySize = {
                1: 1, // T1: 1 character
                2: 2, // T2: 2 characters
                3: 3, // T3: 3 characters
                4: 4, // T4: 4 characters
                5: 5  // T5: 4-6 characters (average 5)
            };
            return tierPartySize[tier] || 1;
        }

        function displayResults(results) {
            const container = document.getElementById('calculation-results');
            const target = document.getElementById('difficulty-target').value;
            
            let recommendationColor = "text-green-600 dark:text-green-400";
            let recommendation = "Balanced encounter!";
            
            if ((target === "easy" && results.powerRatio > 0.6) ||
                (target === "average" && (results.powerRatio < 0.6 || results.powerRatio > 1.1)) ||
                (target === "hard" && results.powerRatio < 0.9)) {
                recommendationColor = "text-yellow-600 dark:text-yellow-400";
                if (results.powerRatio < 0.6) {
                    recommendation = "Consider adding more monsters or using higher tier creatures.";
                } else {
                    recommendation = "Consider reducing monsters or using lower tier creatures.";
                }
            }
            
            container.innerHTML = `
                <div class="space-y-3">
                    <div class="p-4 bg-white dark:bg-gray-700 rounded-lg border">
                        <h3 class="font-semibold mb-2">Encounter Analysis</h3>
                        <p><strong>Difficulty Rating:</strong> ${results.difficulty_rating}</p>
                        <p><strong>Expected Duration:</strong> ${results.expectedRounds} rounds</p>
                        <p><strong>Expected Resource Usage:</strong> ${results.resourceUsage}</p>
                        <p><strong>Party Win Chance:</strong> ${results.winChance}</p>
                        <p><strong>Power Ratio:</strong> ${results.powerRatio.toFixed(2)} (Monster/Party)</p>
                    </div>
                    
                    <div class="p-4 bg-white dark:bg-gray-700 rounded-lg border">
                        <h3 class="font-semibold mb-2">Power Breakdown</h3>
                        <p><strong>Party Power:</strong> ${Math.round(results.partyPower)}</p>
                        <p><strong>Monster Power:</strong> ${Math.round(results.monsterPower)}</p>
                    </div>
                    
                    <div class="p-4 bg-white dark:bg-gray-700 rounded-lg border">
                        <h3 class="font-semibold mb-2">Recommendation</h3>
                        <p class="${recommendationColor}">${recommendation}</p>
                    </div>
                    
                    <div class="p-4 bg-white dark:bg-gray-700 rounded-lg border">
                        <h3 class="font-semibold mb-2">Suggested Adjustments</h3>
                        <div class="text-sm space-y-1">
                            ${generateSuggestions(results)}
                        </div>
                    </div>
                </div>
            `;
        }

        function generateSuggestions(results) {
            const target = document.getElementById('difficulty-target').value;
            let suggestions = [];
            
            if (target === "easy" && results.powerRatio > 0.6) {
                suggestions.push("• Reduce monster quantities by 1-2");
                suggestions.push("• Use lower tier monsters");
                suggestions.push("• Remove monsters with special abilities");
            } else if (target === "average" && results.powerRatio < 0.6) {
                suggestions.push("• Add 1-2 more monsters");
                suggestions.push("• Use higher tier monsters");
                suggestions.push("• Add monsters with interesting abilities");
            } else if (target === "average" && results.powerRatio > 1.1) {
                suggestions.push("• Reduce monster quantities");
                suggestions.push("• Use lower tier monsters");
                suggestions.push("• Consider environmental advantages for players");
            } else if (target === "hard" && results.powerRatio < 0.9) {
                suggestions.push("• Add 2-3 more monsters");
                suggestions.push("• Use higher tier monsters");
                suggestions.push("• Add boss-level creatures");
                suggestions.push("• Include environmental hazards");
            }
            
            if (suggestions.length === 0) {
                suggestions.push("• Encounter appears well-balanced for the target difficulty");
            }
            
            return suggestions.join('<br>');
        }

        function updateEncounterSummary() {
            const partyContainer = document.getElementById('party-summary');
            const encounterContainer = document.getElementById('encounter-summary');
            
            if (party.length === 0) {
                partyContainer.innerHTML = 'No party members added yet.';
            } else {
                const avgLevel = Math.round(party.reduce((sum, char) => sum + char.level, 0) / party.length);
                const totalHP = party.reduce((sum, char) => sum + char.hp, 0);
                const names = party.map(char => char.name).join(', ');
                partyContainer.innerHTML = `${party.length} characters (${names})<br>Average Level: ${avgLevel}, Total HP: ${totalHP}`;
            }
            
            if (encounter.length === 0) {
                encounterContainer.innerHTML = 'No monsters added yet.';
            } else {
                const totalMonsters = encounter.reduce((sum, entry) => sum + entry.quantity, 0);
                const monsterNames = encounter.map(entry => {
                    if (entry.quantity > 1) {
                        return `${entry.quantity}x ${entry.monster.name}`;
                    } else {
                        return entry.monster.name;
                    }
                }).join(', ');
                const tierBreakdown = encounter.map(entry => `${entry.quantity}x T${entry.monster.tier}`).join(', ');
                encounterContainer.innerHTML = `${totalMonsters} monsters (${monsterNames})<br>Tiers: ${tierBreakdown}`;
            }
            
            document.getElementById('party-count').textContent = party.length;
        }

        // Custom alert function
        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4">
                    <p class="text-gray-700 dark:text-gray-300 mb-4">${message}</p>
                    <div class="flex justify-end">
                        <button class="px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded" onclick="this.closest('.fixed').remove()">OK</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        // Monster builder search functions
        function filterBuilderMonsters() {
            const search = document.getElementById('builder-search').value.toLowerCase();
            const select = document.getElementById('builder-monster-select');
            
            // Clear existing options except first
            select.innerHTML = '<option value="">Select monster...</option>';
            
            const allMonsters = [...defaultMonsters, ...customMonsters];
            const filtered = allMonsters.filter(monster => 
                monster.name.toLowerCase().includes(search)
            );
            
            filtered.forEach(monster => {
                const option = document.createElement('option');
                option.value = monster.name;
                option.textContent = `${monster.name} (T${monster.tier})`;
                select.appendChild(option);
            });
        }

        function loadMonsterToBuilder() {
            const selectedName = document.getElementById('builder-monster-select').value;
            if (!selectedName) return;
            
            const allMonsters = [...defaultMonsters, ...customMonsters];
            const monster = allMonsters.find(m => m.name === selectedName);
            
            if (monster) {
                document.getElementById('monster-name').value = monster.name;
                document.getElementById('monster-tier').value = monster.tier;
                document.getElementById('monster-hp').value = monster.hp;
                document.getElementById('monster-stress').value = monster.stress;
                document.getElementById('monster-evasion').value = monster.evasion;
                document.getElementById('monster-threshold-low').value = monster.thresholdLow;
                document.getElementById('monster-threshold-high').value = monster.thresholdHigh;
                document.getElementById('monster-damage-dice').value = monster.damageDice;
                document.getElementById('monster-attack').value = monster.attackMod;
                document.getElementById('monster-features').value = monster.features || '';
                
                // Update guidelines display
                updateMonsterGuidelines();
            }
        }

        // Monster details modal
        function showMonsterDetails(monsterName) {
            const allMonsters = [...defaultMonsters, ...customMonsters];
            const monster = allMonsters.find(m => m.name === monsterName);
            
            if (!monster) return;
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            
            // Handle missing fields with defaults
            const imagePath = monster.image || `monsters/placeholder.jpg`;
            const description = monster.description || "No description available.";
            const ecology = monster.ecology || "No ecology information available.";
            const combat = monster.combat || "No combat information available.";
            
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-2xl w-full max-h-full overflow-y-auto">
                    <div class="p-6">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">${monster.name}</h2>
                            <button onclick="this.closest('.fixed').remove()" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200 text-2xl">×</button>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Image Column -->
                            <div>
                                <div class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 mb-4">
                                    <img src="${imagePath}" alt="${monster.name}" class="w-full h-48 object-cover rounded-lg mb-2" 
                                         onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgZmlsbD0iI2Y3ZjdmNyIvPgogIDx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+Tm8gSW1hZ2U8L3RleHQ+Cjwvc3ZnPg=='">
                                </div>
                                
                                <!-- Stats Box -->
                                <div class="bg-gray-50 dark:bg-gray-700 rounded-lg p-4">
                                    <h3 class="font-semibold mb-2 text-gray-900 dark:text-white">Stats</h3>
                                    <div class="text-sm space-y-1 text-gray-700 dark:text-gray-300">
                                        <p><strong>Tier:</strong> ${monster.tier}</p>
                                        <p><strong>Hit Points:</strong> ${monster.hp}</p>
                                        <p><strong>Stress:</strong> ${monster.stress}</p>
                                        <p><strong>Evasion:</strong> ${monster.evasion}</p>
                                        <p><strong>Threshold:</strong> ${monster.thresholdLow}|${monster.thresholdHigh}</p>
                                        <p><strong>Damage:</strong> ${monster.damageDice}+${monster.attackMod}</p>
                                    </div>
                                    
                                    ${monster.features ? `
                                        <div class="mt-3 pt-3 border-t border-gray-200 dark:border-gray-600">
                                            <h4 class="font-medium mb-1 text-gray-900 dark:text-white">Special Features</h4>
                                            <p class="text-xs text-gray-600 dark:text-gray-400">${monster.features}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Details Column -->
                            <div class="space-y-4">
                                <div>
                                    <h3 class="font-semibold mb-2 text-gray-900 dark:text-white">Description</h3>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">${description}</p>
                                </div>
                                
                                <div>
                                    <h3 class="font-semibold mb-2 text-gray-900 dark:text-white">Ecology</h3>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">${ecology}</p>
                                </div>
                                
                                <div>
                                    <h3 class="font-semibold mb-2 text-gray-900 dark:text-white">Combat</h3>
                                    <p class="text-sm text-gray-700 dark:text-gray-300">${combat}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex gap-3 mt-6 pt-6 border-t border-gray-200 dark:border-gray-600">
                            <button onclick="addMonsterToEncounter('${monster.name}'); this.closest('.fixed').remove();" 
                                    class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors">
                                Add to Encounter
                            </button>
                            <button onclick="this.closest('.fixed').remove()" 
                                    class="px-4 py-2 bg-gray-300 dark:bg-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-400 dark:hover:bg-gray-500 transition-colors">
                                Close
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // Saved party management
        function saveCurrentParty() {
            const partyName = document.getElementById('party-name').value.trim();
            
            if (!partyName) {
                showCustomAlert('Please enter a party name!');
                return;
            }
            
            if (party.length === 0) {
                showCustomAlert('Please add characters to the party first!');
                return;
            }
            
            // Get existing saved parties
            const savedParties = JSON.parse(localStorage.getItem('encounterBalancer_savedParties') || '{}');
            
            // Save the current party
            savedParties[partyName] = {
                name: partyName,
                size: party.length,
                characters: [...party],
                savedDate: new Date().toISOString()
            };
            
            // Store back to localStorage
            localStorage.setItem('encounterBalancer_savedParties', JSON.stringify(savedParties));
            
            // Clear the input and update dropdown
            document.getElementById('party-name').value = '';
            updateSavedPartiesDropdown();
            
            showCustomAlert(`Party "${partyName}" saved successfully!`);
        }

        function loadSavedParty() {
            const selectedPartyName = document.getElementById('saved-parties').value;
            
            if (!selectedPartyName) {
                showCustomAlert('Please select a saved party first!');
                return;
            }
            
            // Get saved parties from localStorage
            const savedParties = JSON.parse(localStorage.getItem('encounterBalancer_savedParties') || '{}');
            const savedParty = savedParties[selectedPartyName];
            
            if (!savedParty) {
                showCustomAlert('Saved party not found!');
                return;
            }
            
            // Load the party data
            party = [...savedParty.characters];
            
            // Update party size dropdown to match loaded party
            document.getElementById('party-size').value = savedParty.size;
            
            // Re-render the party and update encounter summary
            renderParty();
            updateEncounterSummary();
            
            showCustomAlert(`Party "${selectedPartyName}" loaded successfully!`);
        }

        function updateSavedPartiesDropdown() {
            const dropdown = document.getElementById('saved-parties');
            const savedParties = JSON.parse(localStorage.getItem('encounterBalancer_savedParties') || '{}');
            
            // Clear existing options except the first one
            dropdown.innerHTML = '<option value="">Select saved party...</option>';
            
            // Add saved parties to dropdown
            Object.keys(savedParties).sort().forEach(partyName => {
                const option = document.createElement('option');
                option.value = partyName;
                const party = savedParties[partyName];
                const savedDate = new Date(party.savedDate).toLocaleDateString();
                option.textContent = `${partyName} (${party.size} chars - ${savedDate})`;
                dropdown.appendChild(option);
            });
        }

        // Delete saved party function with confirmation
        function deleteSavedParty() {
            const selectedPartyName = document.getElementById('saved-parties').value;
            
            if (!selectedPartyName) {
                showCustomAlert('Please select a saved party to delete!');
                return;
            }
            
            // Show confirmation modal
            showDeleteConfirmDialog(selectedPartyName);
        }

        // Custom confirmation dialog for party deletion
        function showDeleteConfirmDialog(partyName) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Confirm Deletion</h3>
                    <p class="text-gray-700 dark:text-gray-300 mb-6">Are you sure you want to delete the party "${partyName}"? This action cannot be undone.</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancel-delete" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">Cancel</button>
                        <button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded transition-colors">Delete</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners
            document.getElementById('cancel-delete').addEventListener('click', () => {
                modal.remove();
            });
            
            document.getElementById('confirm-delete').addEventListener('click', () => {
                // User confirmed deletion
                const savedParties = JSON.parse(localStorage.getItem('encounterBalancer_savedParties') || '{}');
                delete savedParties[partyName];
                localStorage.setItem('encounterBalancer_savedParties', JSON.stringify(savedParties));
                
                // Update dropdown and clear selection
                updateSavedPartiesDropdown();
                document.getElementById('saved-parties').value = '';
                
                // Close modal and show success message
                modal.remove();
                showCustomAlert(`Party "${partyName}" deleted successfully!`);
            });
        }

        // Initiative Tracker State
        let initiativeEntries = [];
        let nextEntryId = 1;
        let combatActive = false;
        let currentTurnIndex = 0;
        let currentRound = 1;

        // Common condition list
        const conditions = [
            'None',
            'Blinded',
            'Burning',
            'Charmed', 
            'Deafened',
            'Diseased',
            'Frightened',
            'Grappled',
            'Invisible',
            'Paralyzed',
            'Poisoned',
            'Restrained',
            'Stunned',
            'Unconscious',
        ];

        // Show screens function
        function showScreen(screenName) {
            const mainContainer = document.querySelector('.container.mx-auto');
            const initiativeScreen = document.getElementById('initiativeScreen');
            
            if (screenName === 'encounterScreen') {
                // Hide initiative tracker and show main interface
                initiativeScreen.classList.add('hidden');
                mainContainer.classList.remove('hidden');
                showTab('encounter'); // Make sure encounter tab is active
            } else if (screenName === 'initiativeScreen') {
                // Hide main interface and show initiative tracker
                mainContainer.classList.add('hidden');
                initiativeScreen.classList.remove('hidden');
            }
        }

        // Combat Control Functions
        function startCombat() {
            if (initiativeEntries.length === 0) {
                showCustomAlert('Please add creatures to the initiative tracker first!');
                return;
            }
            
            combatActive = true;
            currentTurnIndex = 0;
            currentRound = 1; // Reset round counter
            
            // Update button visibility
            document.getElementById('start-combat-btn').classList.add('hidden');
            document.getElementById('advance-turn-btn').classList.remove('hidden');
            document.getElementById('stop-combat-btn').classList.remove('hidden');
            
            // Show round counter and update display
            document.getElementById('round-counter').classList.remove('hidden');
            document.getElementById('round-number').textContent = currentRound;
            
            // Re-render to apply highlighting
            renderInitiativeList();
            
            // Scroll to current turn creature
            setTimeout(() => scrollToCurrentTurn(), 100);
        }

        function advanceTurn() {
            if (!combatActive || initiativeEntries.length === 0) return;

            // Get the current sorted order
            const sortedEntries = [...initiativeEntries].sort((a, b) => {
                if (b.initiative !== a.initiative) {
                    return b.initiative - a.initiative;
                }
                return a.type === 'player' ? -1 : 1;
            });

            if (sortedEntries.length === 0) return;

            const previousTurnIndex = currentTurnIndex;
            let nextTurnIndex = currentTurnIndex;
            let attempts = 0;
            const maxAttempts = sortedEntries.length;

            // Find the next creature with HP > 0 and not hidden
            do {
                nextTurnIndex = (nextTurnIndex + 1) % sortedEntries.length;
                attempts++;

                // If we've checked everyone and they're all at 0 HP or hidden, stop combat
                if (attempts > maxAttempts) {
                    showCustomAlert('All creatures are at 0 HP or hidden. Combat has ended.');
                    stopCombat();
                    return;
                }
            } while (sortedEntries[nextTurnIndex].hp <= 0 || sortedEntries[nextTurnIndex].hidden);

            currentTurnIndex = nextTurnIndex;

            // Check if we've completed a full round (wrapped around past the starting position)
            if (previousTurnIndex >= nextTurnIndex) {
                currentRound++;
                document.getElementById('round-number').textContent = currentRound;
            }

            renderInitiativeList();

            // Scroll to the current turn creature
            setTimeout(() => scrollToCurrentTurn(), 100);
        }

        function stopCombat() {
            combatActive = false;
            currentTurnIndex = 0;
            currentRound = 1; // Reset round counter
            
            // Update button visibility
            document.getElementById('start-combat-btn').classList.remove('hidden');
            document.getElementById('advance-turn-btn').classList.add('hidden');
            document.getElementById('stop-combat-btn').classList.add('hidden');
            
            // Hide round counter
            document.getElementById('round-counter').classList.add('hidden');
            
            // Re-render to remove highlighting
            renderInitiativeList();
        }

        // Open Initiative Tracker
        function openInitiativeTracker() {
            // Clear existing entries
            initiativeEntries = [];
            nextEntryId = 1;

            // Add party members
            party.forEach((character, index) => {
                // Extract first name only (split by space and take first part)
                const firstName = character.name.split(' ')[0] || character.name;
                
                initiativeEntries.push({
                    id: nextEntryId++,
                    initiative: 0,
                    name: firstName,
                    type: 'player',
                    evasion: character.evasion,
                    hp: character.hp,
                    maxHp: character.hp,
                    stress: character.stress,
                    maxStress: character.stress,
                    threshold: `${character.thresholdLow} | ${character.thresholdHigh}`,
                    damage: character.damageDice,
                    conditions: [],
                    hidden: false
                });
            });

            // Add monsters with numbering
            encounter.forEach(entry => {
                for (let i = 1; i <= entry.quantity; i++) {
                    const monsterName = entry.quantity > 1 ? `${entry.monster.name} ${i}` : entry.monster.name;
                    initiativeEntries.push({
                        id: nextEntryId++,
                        initiative: 0,
                        name: monsterName,
                        type: 'monster',
                        evasion: entry.monster.evasion,
                        hp: entry.monster.hp,
                        maxHp: entry.monster.hp,
                        stress: entry.monster.stress,
                        maxStress: entry.monster.stress,
                        threshold: `${entry.monster.thresholdLow} | ${entry.monster.thresholdHigh}`,
                        damage: `${entry.monster.damageDice}+${entry.monster.attackMod}`,
                        conditions: [],
                        hidden: false
                    });
                }
            });
            
            // Reset combat state when opening tracker
            combatActive = false;
            currentTurnIndex = 0;
            
            // Ensure correct button visibility
            document.getElementById('start-combat-btn').classList.remove('hidden');
            document.getElementById('advance-turn-btn').classList.add('hidden');
            document.getElementById('stop-combat-btn').classList.add('hidden');

            // Show the Initiative Tracker
            showScreen('initiativeScreen');
            renderInitiativeList();
        }

        // Toggle hidden status for an entry
        function toggleHidden(entryId) {
            const entry = initiativeEntries.find(e => e.id === entryId);
            if (entry) {
                entry.hidden = !entry.hidden;
                renderInitiativeList();
            }
        }

        // Render the initiative list
        function renderInitiativeList() {
            const container = document.getElementById('initiativeList');
            container.innerHTML = '';

            // Sort by initiative (descending), then by type (players first for ties)
            const sortedEntries = [...initiativeEntries].sort((a, b) => {
                if (b.initiative !== a.initiative) {
                    return b.initiative - a.initiative;
                }
                return a.type === 'player' ? -1 : 1;
            });

            sortedEntries.forEach((entry, sortedIndex) => {
                const row = document.createElement('div');
                // Add greyout styling when HP is 0 or hidden
                const isDefeated = entry.hp === 0;
                const isHidden = entry.hidden;
                const baseColor = entry.type === 'player' ? 'bg-blue-50 dark:bg-blue-900/20' : 'bg-red-50 dark:bg-red-900/20';
                const greyoutColor = 'bg-gray-200 dark:bg-gray-700 opacity-60';
                let bgColor = (isDefeated || isHidden) ? greyoutColor : baseColor;
                
                // Add current turn highlighting
                const isCurrentTurn = combatActive && sortedIndex === currentTurnIndex;
                if (isCurrentTurn && !isDefeated && !isHidden) {
                    bgColor += ' current-turn';
                }
                
                // Desktop Grid Layout (md and up)
                const desktopLayout = `
                    <div class="hidden md:grid grid-cols-10 gap-2 lg:gap-4 p-3 rounded-lg ${bgColor} border">    
                        <!-- Initiative -->
                        <div>
                            <input type="number" 
                                   value="${entry.initiative}" 
                                   onchange="updateInitiative(${entry.id}, this.value)"
                                   class="w-14 lg:w-16 p-1 lg:p-2 text-center border rounded text-xl lg:text-base bg-white dark:bg-gray-700">
                        </div>
                        
                        <!-- Name -->
                        <div class="flex items-left">
                            ${entry.type === 'monster' ? `
                                <button onclick="showInitiativeMonsterDetails('${entry.name}')" class="font-medium text-red-800 dark:text-red-200 hover:text-red-600 dark:hover:text-red-400 text-left  cursor-pointer text-xl">
                                    ${entry.name}
                                </button>
                            ` : `
                                <span class="font-medium text-blue-800 dark:text-blue-200 text-base">
                                    ${entry.name}
                                </span>
                            `}
                        </div>
                        
                        <!-- Evasion -->
                        <div class="flex items-center list-outside">
                            <button onclick="openStatsModal(${entry.id})" class="text-center text-xl hover:bg-gray-200 dark:hover:bg-gray-600 px-2 py-1 rounded cursor-pointer " title="Click to edit">
                                ${entry.evasion}
                            </button>
                        </div>
                        
                        <!-- HP -->
                        <div>
                            <div class="flex items-center gap-1">
                                <input type="number" 
                                       value="${entry.hp}" 
                                       onchange="updateHP(${entry.id}, this.value)"
                                       class="w-10 p-1 text-center border rounded text-xl bg-white dark:bg-gray-700">
                                <span class="text-xl text-gray-600 dark:text-gray-400">/${entry.maxHp}</span>
                                <div class="flex flex-col">
                                    <button onclick="modifyHP(${entry.id}, 1)" 
                                            class="px-1 py-0 bg-green-500 text-white rounded text-xs hover:bg-green-600 leading-tight"
                                            title="+1 HP">+</button>
                                    <button onclick="modifyHP(${entry.id}, -1)" 
                                            class="px-1 py-0 bg-red-500 text-white rounded text-xs hover:bg-red-600 leading-tight mt-0.5"
                                            title="-1 HP">-</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Stress -->
                        <div>
                            <div class="flex items-center gap-1">
                                <input type="number" 
                                       value="${entry.stress}" 
                                       max="${entry.maxStress}"
                                       onchange="updateStress(${entry.id}, this.value)"
                                       class="w-10 p-1 text-center border rounded text-xl bg-white dark:bg-gray-700">
                                <span class="text-xl text-gray-600 dark:text-gray-400">/${entry.maxStress}</span>
                                <div class="flex flex-col">
                                    <button onclick="modifyStress(${entry.id}, 1)" 
                                            class="px-1 py-0 bg-blue-500 text-white rounded text-xs hover:bg-blue-600 leading-tight"
                                            title="+1 Stress">+</button>
                                    <button onclick="modifyStress(${entry.id}, -1)" 
                                            class="px-1 py-0 bg-orange-500 text-white rounded text-xs hover:bg-orange-600 leading-tight mt-0.5"
                                            title="-1 Stress">-</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Threshold -->
                        <div class="flex items-center list-outside">
                            <button onclick="openStatsModal(${entry.id})" class="text-center text-xl hover:bg-gray-200 dark:hover:bg-gray-600 px-1 py-1 rounded cursor-pointer" title="Click to edit">
                                ${entry.threshold}
                            </button>
                        </div>
                        
                        <!-- Damage -->                        
                        <div class="flex items-center list-outside">
                            <span class="text-center text-xl">${entry.damage}</span>                        
                        </div> 

                        <!-- Conditions -->
                        <div id="conditions-${entry.id}-desktop">
                            ${renderConditions(entry, 'desktop')}
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex gap-1 items-start">
                            <button onclick="rollInitiative(${entry.id})" 
                                    class="px-2 py-1 bg-purple-500 text-white rounded text-xs hover:bg-purple-600" 
                                    title="Roll Initiative">🎲</button>
                            <button onclick="toggleHidden(${entry.id})" 
                                    class="px-2 py-1 ${entry.hidden ? 'bg-gray-500' : 'bg-indigo-500'} text-white rounded text-xs hover:${entry.hidden ? 'bg-gray-600' : 'bg-indigo-600'}" 
                                    title="${entry.hidden ? 'Show' : 'Hide'}">${entry.hidden ? '👻' : '👁️'}</button>
                            <button onclick="removeEntry(${entry.id})" 
                                    class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600"
                                    title="Remove">×</button>
                        </div>
                    </div>
                `;
                
                // Mobile Card Layout (smaller than md)
                const mobileLayout = `
                    <div class="md:hidden p-3 rounded-lg ${bgColor} border">
                        <!-- Header Row: Initiative, Name, Actions -->
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-3">
                                <div class="flex items-center gap-1">
                                    <span class="text-xs font-medium text-gray-600 dark:text-gray-400">Init:</span>
                                    <input type="number" 
                                           value="${entry.initiative}" 
                                           onchange="updateInitiative(${entry.id}, this.value)"
                                           class="w-12 p-1 text-center border rounded text-base bg-white dark:bg-gray-700">
                                </div>
                                
                                <div class="min-w-0 flex-1">
                                    ${entry.type === 'monster' ? `
                                        <button onclick="showInitiativeMonsterDetails('${entry.name}')" class="font-medium text-red-800 dark:text-red-200 hover:text-red-600 dark:hover:text-red-400 text-left  cursor-pointer text-base truncate block">
                                            ${entry.name}
                                        </button>
                                    ` : `
                                        <span class="font-medium text-blue-800 dark:text-blue-200 text-base truncate block">
                                            ${entry.name}
                                        </span>
                                    `}
                                </div>
                            </div>
                            
                            <div class="flex gap-1">
                                ${combatActive && isCurrentTurn ? `
                                    <button onclick="advanceTurn()" 
                                            class="px-2 py-1 bg-yellow-600 text-white rounded text-xs hover:bg-yellow-700" 
                                            title="Advance Turn">⏭️</button>
                                ` : `
                                    <button onclick="rollInitiative(${entry.id})" 
                                            class="px-2 py-1 bg-purple-500 text-white rounded text-xs hover:bg-purple-600" 
                                            title="Roll Initiative">🎲</button>
                                `}
                                <button onclick="toggleHidden(${entry.id})" 
                                        class="px-2 py-1 ${entry.hidden ? 'bg-gray-500' : 'bg-indigo-500'} text-white rounded text-xs hover:${entry.hidden ? 'bg-gray-600' : 'bg-indigo-600'}" 
                                        title="${entry.hidden ? 'Show' : 'Hide'}">${entry.hidden ? '👻' : '👁️'}</button>
                                <button onclick="removeEntry(${entry.id})" 
                                        class="px-2 py-1 bg-red-500 text-white rounded text-xs hover:bg-red-600"
                                        title="Remove">×</button>
                            </div>
                        </div>
                        
                        <!-- Stats Row: Evasion, HP, Stress, Threshold -->
                        <div class="grid grid-cols-2 gap-3 mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-medium text-gray-600 dark:text-gray-400 min-w-0">Eva:</span>
                                <button onclick="openStatsModal(${entry.id})" class="text-base hover:bg-gray-200 dark:hover:bg-gray-600 px-2 py-1 rounded cursor-pointer" title="Click to edit">
                                    ${entry.evasion}
                                </button>
                            </div>
                            
                            <div class="flex items-center gap-1">
                                <span class="text-xs font-medium text-gray-600 dark:text-gray-400 min-w-0">HP:</span>
                                <input type="number" 
                                       value="${entry.hp}" 
                                       onchange="updateHP(${entry.id}, this.value)"
                                       class="w-12 p-1 text-center border rounded text-base bg-white dark:bg-gray-700">
                                <span class="text-sm text-gray-600 dark:text-gray-400">/${entry.maxHp}</span>
                                <div class="flex gap-1">
                                    <button onclick="modifyHP(${entry.id}, 1)" 
                                            class="px-1.5 py-0.5 bg-green-500 text-white rounded text-xs hover:bg-green-600"
                                            title="+1 HP">+</button>
                                    <button onclick="modifyHP(${entry.id}, -1)" 
                                            class="px-1.5 py-0.5 bg-red-500 text-white rounded text-xs hover:bg-red-600"
                                            title="-1 HP">-</button>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-1">
                                <span class="text-xs font-medium text-gray-600 dark:text-gray-400 min-w-0">Stress:</span>
                                <input type="number" 
                                       value="${entry.stress}" 
                                       max="${entry.maxStress}"
                                       onchange="updateStress(${entry.id}, this.value)"
                                       class="w-12 p-1 text-center border rounded text-base bg-white dark:bg-gray-700">
                                <span class="text-sm text-gray-600 dark:text-gray-400">/${entry.maxStress}</span>
                                <div class="flex gap-1">
                                    <button onclick="modifyStress(${entry.id}, 1)" 
                                            class="px-1.5 py-0.5 bg-blue-500 text-white rounded text-xs hover:bg-blue-600"
                                            title="+1 Stress">+</button>
                                    <button onclick="modifyStress(${entry.id}, -1)" 
                                            class="px-1.5 py-0.5 bg-orange-500 text-white rounded text-xs hover:bg-orange-600"
                                            title="-1 Stress">-</button>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-2">
                                <span class="text-xs font-medium text-gray-600 dark:text-gray-400 min-w-0">Threshold:</span>
                                <button onclick="openStatsModal(${entry.id})" class="text-base hover:bg-gray-200 dark:hover:bg-gray-600 px-2 py-1 rounded cursor-pointer" title="Click to edit">
                                    ${entry.threshold}
                                </button>
                            </div>
                        </div>

                        <!-- Damage -->                        
                        <div class="flex items-center">
                            <span class="text-xs font-medium text-gray-600 dark:text-gray-400 min-w-0">Dmg:</span>
                            <span class="text-center text-xs">${entry.damage}</span>                        
                        </div> 
                        
                        <!-- Conditions Row -->
                        <div>
                            <div class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-1">Conditions:</div>
                            <div id="conditions-${entry.id}-mobile">
                                ${renderConditions(entry, 'mobile')}
                            </div>
                        </div>
                    </div>
                `;
                
                row.innerHTML = desktopLayout + mobileLayout;
                container.appendChild(row);
            });
        }

        // Render conditions for an entry
        function renderConditions(entry, mode = 'desktop') {
            const selectSize = mode === 'mobile' ? 'text-sm' : 'text-xs';
            
            if (entry.conditions.length === 0) {
                return `
                    <select onchange="addCondition(${entry.id}, this.value); this.value = 'None';" 
                            class="w-full p-1 ${selectSize} border rounded bg-white dark:bg-gray-700">
                        ${conditions.map(condition => `<option value="${condition}">${condition}</option>`).join('')}
                    </select>
                `;
            }

            let html = '';
            entry.conditions.forEach((condition, index) => {
                html += `
                    <div class="flex items-center gap-1 mb-1">
                        <select onchange="updateCondition(${entry.id}, ${index}, this.value)" 
                                class="flex-1 p-1 ${selectSize} border rounded bg-white dark:bg-gray-700">
                            ${conditions.map(cond => `<option value="${cond}" ${cond === condition ? 'selected' : ''}>${cond}</option>`).join('')}
                        </select>
                        <button onclick="removeCondition(${entry.id}, ${index})" 
                                class="px-1 py-1 bg-red-400 text-white rounded text-xs hover:bg-red-500">×</button>
                    </div>
                `;
            });
            
            // Add dropdown for new condition
            html += `
                <select onchange="addCondition(${entry.id}, this.value); this.value = 'None';" 
                        class="w-full p-1 ${selectSize} border rounded bg-white dark:bg-gray-700">
                    ${conditions.map(condition => `<option value="${condition}">${condition}</option>`).join('')}
                </select>
            `;
            
            return html;
        }

        // Update initiative and re-sort
        function updateInitiative(entryId, newInitiative) {
            const entry = initiativeEntries.find(e => e.id === entryId);
            if (entry) {
                entry.initiative = parseInt(newInitiative) || 0;
                renderInitiativeList(); // Re-render to re-sort
            }
        }

        // Update HP
        function updateHP(entryId, newHP) {
            const entry = initiativeEntries.find(e => e.id === entryId);
            if (entry) {
                entry.hp = Math.max(0, parseInt(newHP) || 0); // Remove max HP constraint to allow over-healing
                renderInitiativeList(); // Refresh the entire display to update greyout effect
            }
        }

        // Modify HP by amount (+1 or -1)
        function modifyHP(entryId, amount) {
            const entry = initiativeEntries.find(e => e.id === entryId);
            if (entry) {
                entry.hp = Math.max(0, entry.hp + amount);
                renderInitiativeList();
            }
        }

        // Update Stress
        function updateStress(entryId, newStress) {
            const entry = initiativeEntries.find(e => e.id === entryId);
            if (entry) {
                entry.stress = Math.max(0, Math.min(parseInt(newStress) || 0, entry.maxStress));
                renderInitiativeList(); // Refresh the entire display for consistency
            }
        }

        // Modify Stress by amount (+1 or -1)
        function modifyStress(entryId, amount) {
            const entry = initiativeEntries.find(e => e.id === entryId);
            if (entry) {
                entry.stress = Math.max(0, Math.min(entry.stress + amount, entry.maxStress));
                renderInitiativeList();
            }
        }


        // Add condition
        function addCondition(entryId, condition) {
            if (condition === 'None') return;
            
            const entry = initiativeEntries.find(e => e.id === entryId);
            if (entry && !entry.conditions.includes(condition)) {
                entry.conditions.push(condition);
                // Update both desktop and mobile condition containers
                const desktopContainer = document.getElementById(`conditions-${entryId}-desktop`);
                const mobileContainer = document.getElementById(`conditions-${entryId}-mobile`);
                if (desktopContainer) desktopContainer.innerHTML = renderConditions(entry, 'desktop');
                if (mobileContainer) mobileContainer.innerHTML = renderConditions(entry, 'mobile');
            }
        }

        // Update condition
        function updateCondition(entryId, conditionIndex, newCondition) {
            const entry = initiativeEntries.find(e => e.id === entryId);
            if (entry && conditionIndex < entry.conditions.length) {
                if (newCondition === 'None') {
                    entry.conditions.splice(conditionIndex, 1);
                } else {
                    entry.conditions[conditionIndex] = newCondition;
                }
                // Update both desktop and mobile condition containers
                const desktopContainer = document.getElementById(`conditions-${entryId}-desktop`);
                const mobileContainer = document.getElementById(`conditions-${entryId}-mobile`);
                if (desktopContainer) desktopContainer.innerHTML = renderConditions(entry, 'desktop');
                if (mobileContainer) mobileContainer.innerHTML = renderConditions(entry, 'mobile');
            }
        }

        // Remove condition
        function removeCondition(entryId, conditionIndex) {
            const entry = initiativeEntries.find(e => e.id === entryId);
            if (entry && conditionIndex < entry.conditions.length) {
                entry.conditions.splice(conditionIndex, 1);
                // Update both desktop and mobile condition containers
                const desktopContainer = document.getElementById(`conditions-${entryId}-desktop`);
                const mobileContainer = document.getElementById(`conditions-${entryId}-mobile`);
                if (desktopContainer) desktopContainer.innerHTML = renderConditions(entry, 'desktop');
                if (mobileContainer) mobileContainer.innerHTML = renderConditions(entry, 'mobile');
            }
        }

        // Roll initiative for single entry
        function rollInitiative(entryId) {
            const entry = initiativeEntries.find(e => e.id === entryId);
            if (entry) {
                // Roll 1d20 for initiative
                let roll = Math.floor(Math.random() * 20) + 1;
                
                // Add modifier for monsters (use attack modifier as initiative modifier)
                if (entry.type === 'monster') {
                    // Find the original monster to get attack modifier
                    const baseName = entry.name.replace(/ \d+$/, '');
                    const encounterEntry = encounter.find(e => e.monster.name === baseName);
                    if (encounterEntry && encounterEntry.monster.attackMod) {
                        roll += encounterEntry.monster.attackMod;
                    } else {
                        // Fallback: check monster libraries
                        const allMonsters = [...defaultMonsters, ...customMonsters];
                        const monster = allMonsters.find(m => m.name === baseName);
                        if (monster && monster.attackMod) {
                            roll += monster.attackMod;
                        }
                    }
                }
                
                entry.initiative = Math.max(1, roll); // Minimum of 1
                renderInitiativeList();
            }
        }

        // Roll initiative for all entries
        function rollInitiativeForAll() {
            initiativeEntries.forEach(entry => {
                let roll = Math.floor(Math.random() * 20) + 1;
                
                // Add modifier for monsters (use attack modifier as initiative modifier)
                if (entry.type === 'monster') {
                    // Find the original monster to get attack modifier
                    const baseName = entry.name.replace(/ \d+$/, '');
                    const encounterEntry = encounter.find(e => e.monster.name === baseName);
                    if (encounterEntry && encounterEntry.monster.attackMod) {
                        roll += encounterEntry.monster.attackMod;
                    } else {
                        // Fallback: check monster libraries
                        const allMonsters = [...defaultMonsters, ...customMonsters];
                        const monster = allMonsters.find(m => m.name === baseName);
                        if (monster && monster.attackMod) {
                            roll += monster.attackMod;
                        }
                    }
                }
                
                entry.initiative = Math.max(1, roll); // Minimum of 1
            });
            renderInitiativeList();
        }

        // Reset all initiative to 0
        function resetInitiative() {
            initiativeEntries.forEach(entry => {
                entry.initiative = 0;
            });
            renderInitiativeList();
        }

        // Clear all conditions
        function clearAllConditions() {
            initiativeEntries.forEach(entry => {
                entry.conditions = [];
            });
            renderInitiativeList();
        }

        // Remove entry
        function removeEntry(entryId) {
            initiativeEntries = initiativeEntries.filter(entry => entry.id !== entryId);
            renderInitiativeList();
        }

        // Add custom entry
        function addCustomEntry() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg max-w-md w-full max-h-full overflow-y-auto">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Add Custom Entry</h3>
                        
                        <!-- Monster Search Section -->
                        <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg border">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Load From Monster Library</label>
                            <div class="space-y-2">
                                <input type="text" id="custom-monster-search" placeholder="Search monsters..." 
                                       class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base" 
                                       oninput="filterCustomMonsterSelect()">
                                <div class="flex gap-2">
                                    <select id="custom-monster-select" class="flex-1 p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                                        <option value="">Select monster...</option>
                                    </select>
                                    <button type="button" onclick="loadSelectedMonsterToCustomForm()" class="px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm">Load</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Manual Entry Form -->
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Name</label>
                                <input type="text" id="custom-entry-name" placeholder="Enter name..." 
                                       class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Evasion</label>
                                <input type="number" id="custom-entry-evasion" value="10" min="1" max="30" 
                                       class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Hit Points</label>
                                    <input type="number" id="custom-entry-hp" value="1" min="1" max="50" 
                                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Stress</label>
                                    <input type="number" id="custom-entry-stress" value="0" min="0" max="20" 
                                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Threshold Lower</label>
                                    <input type="number" id="custom-entry-threshold-low" value="1" min="1" max="50" 
                                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Threshold Upper</label>
                                    <input type="number" id="custom-entry-threshold-high" value="10" min="2" max="100" 
                                           class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Damage</label>
                                <div class="grid grid-cols-3 gap-2 items-end">
                                    <div>
                                        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Number of Dice</label>
                                        <select id="custom-entry-dice-count" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                                            <option value="1" selected>1</option>
                                            <option value="2">2</option>
                                            <option value="3">3</option>
                                            <option value="4">4</option>
                                            <option value="5">5</option>
                                            <option value="6">6</option>
                                            <option value="7">7</option>
                                            <option value="8">8</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Die Type</label>
                                        <select id="custom-entry-die-type" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                                            <option value="4">d4</option>
                                            <option value="6" selected>d6</option>
                                            <option value="8">d8</option>
                                            <option value="10">d10</option>
                                            <option value="12">d12</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-xs text-gray-500 dark:text-gray-400 mb-1">Modifier</label>
                                        <input type="number" id="custom-entry-damage-mod" value="0" min="-10" max="20" 
                                               class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                                    </div>
                                </div>
                                <div id="damage-preview" class="mt-2 text-sm text-gray-600 dark:text-gray-400">
                                    Damage: <span id="damage-display">1d6</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex justify-end space-x-3 mt-6">
                            <button id="cancel-custom-entry" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">Cancel</button>
                            <button id="confirm-custom-entry" class="px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded transition-colors">Add Entry</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Populate monster dropdown
            populateCustomMonsterDropdown();
            
            // Update damage display when inputs change
            updateDamageDisplay();
            document.getElementById('custom-entry-dice-count').addEventListener('change', updateDamageDisplay);
            document.getElementById('custom-entry-die-type').addEventListener('change', updateDamageDisplay);
            document.getElementById('custom-entry-damage-mod').addEventListener('change', updateDamageDisplay);
            
            // Focus on name input
            document.getElementById('custom-entry-name').focus();
            
            // Add event listeners
            document.getElementById('cancel-custom-entry').addEventListener('click', () => {
                modal.remove();
            });
            
            document.getElementById('confirm-custom-entry').addEventListener('click', () => {
                const name = document.getElementById('custom-entry-name').value.trim();
                if (!name) {
                    showCustomAlert('Please enter a name for the custom entry!');
                    return;
                }
                
                const hp = parseInt(document.getElementById('custom-entry-hp').value) || 1;
                const stress = parseInt(document.getElementById('custom-entry-stress').value) || 0;
                const thresholdLow = parseInt(document.getElementById('custom-entry-threshold-low').value) || 1;
                const thresholdHigh = parseInt(document.getElementById('custom-entry-threshold-high').value) || 10;
                
                // Validate threshold values
                if (thresholdHigh <= thresholdLow) {
                    showCustomAlert('Threshold Upper must be greater than Threshold Lower!');
                    return;
                }
                
                const diceCount = document.getElementById('custom-entry-dice-count').value;
                const dieType = document.getElementById('custom-entry-die-type').value;
                const damageMod = parseInt(document.getElementById('custom-entry-damage-mod').value) || 0;
                
                // Build damage string
                let damageString = `${diceCount}d${dieType}`;
                if (damageMod > 0) {
                    damageString += `+${damageMod}`;
                } else if (damageMod < 0) {
                    damageString += `${damageMod}`;
                }
                
                const customEntry = {
                    id: nextEntryId++,
                    initiative: 0,
                    name: name,
                    type: 'custom',
                    evasion: parseInt(document.getElementById('custom-entry-evasion').value) || 10,
                    hp: hp,
                    maxHp: hp,
                    stress: stress,
                    maxStress: stress,
                    threshold: `${thresholdLow}|${thresholdHigh}`,
                    damage: damageString,
                    conditions: [],
                    hidden: false
                };

                initiativeEntries.push(customEntry);
                renderInitiativeList();
                modal.remove();
            });
            
            // Allow Enter key to confirm (only on name field to avoid conflicts)
            document.getElementById('custom-entry-name').addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('confirm-custom-entry').click();
                }
            });
            
            // Allow Escape key to cancel
            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.getElementById('cancel-custom-entry').click();
                }
            });
        }
        
        // Helper functions for custom entry modal
        function populateCustomMonsterDropdown() {
            const select = document.getElementById('custom-monster-select');
            select.innerHTML = '<option value="">Select monster...</option>';
            
            const allMonsters = [...defaultMonsters, ...customMonsters];
            allMonsters.forEach(monster => {
                const option = document.createElement('option');
                option.value = monster.name;
                option.textContent = `${monster.name} (T${monster.tier})`;
                select.appendChild(option);
            });
        }
        
        function filterCustomMonsterSelect() {
            const search = document.getElementById('custom-monster-search').value.toLowerCase();
            const select = document.getElementById('custom-monster-select');
            
            // Clear existing options except first
            select.innerHTML = '<option value="">Select monster...</option>';
            
            const allMonsters = [...defaultMonsters, ...customMonsters];
            const filtered = allMonsters.filter(monster => 
                monster.name.toLowerCase().includes(search)
            );
            
            filtered.forEach(monster => {
                const option = document.createElement('option');
                option.value = monster.name;
                option.textContent = `${monster.name} (T${monster.tier})`;
                select.appendChild(option);
            });
        }
        
        function loadSelectedMonsterToCustomForm() {
            const selectedName = document.getElementById('custom-monster-select').value;
            if (!selectedName) {
                showCustomAlert('Please select a monster first!');
                return;
            }
            
            const allMonsters = [...defaultMonsters, ...customMonsters];
            const monster = allMonsters.find(m => m.name === selectedName);
            
            if (monster) {
                document.getElementById('custom-entry-name').value = monster.name;
                document.getElementById('custom-entry-evasion').value = monster.evasion;
                document.getElementById('custom-entry-hp').value = monster.hp;
                document.getElementById('custom-entry-stress').value = monster.stress;
                document.getElementById('custom-entry-threshold-low').value = monster.thresholdLow;
                document.getElementById('custom-entry-threshold-high').value = monster.thresholdHigh;
                
                // Parse damage dice (e.g., "2d6" or "1d8+3")
                const damageString = monster.damageDice || '1d6';
                const damageMatch = damageString.match(/(\d+)d(\d+)(?:\+(\d+))?/);
                if (damageMatch) {
                    document.getElementById('custom-entry-dice-count').value = damageMatch[1];
                    document.getElementById('custom-entry-die-type').value = damageMatch[2];
                    
                    // Handle modifier from monster.attackMod or from damage string
                    let modifier = 0;
                    if (damageMatch[3]) {
                        modifier = parseInt(damageMatch[3]);
                    } else if (monster.attackMod) {
                        modifier = monster.attackMod;
                    }
                    document.getElementById('custom-entry-damage-mod').value = modifier;
                }
                
                updateDamageDisplay();
            }
        }
        
        function updateDamageDisplay() {
            const diceCount = document.getElementById('custom-entry-dice-count').value;
            const dieType = document.getElementById('custom-entry-die-type').value;
            const damageMod = parseInt(document.getElementById('custom-entry-damage-mod').value) || 0;
            
            let damageString = `${diceCount}d${dieType}`;
            if (damageMod > 0) {
                damageString += `+${damageMod}`;
            } else if (damageMod < 0) {
                damageString += `${damageMod}`;
            }
            
            document.getElementById('damage-display').textContent = damageString;
        }

        // Show monster details from initiative tracker
        function showInitiativeMonsterDetails(entryName) {
            // Remove numbering from the name to find the base monster
            const baseName = entryName.replace(/ \d+$/, '');
            
            // Look for the monster in the encounter and monster libraries
            let monster = null;
            
            // First check the current encounter
            const encounterEntry = encounter.find(entry => entry.monster.name === baseName);
            if (encounterEntry) {
                monster = encounterEntry.monster;
            } else {
                // Check default monsters and custom monsters
                const allMonsters = [...defaultMonsters, ...customMonsters];
                monster = allMonsters.find(m => m.name === baseName);
            }

            if (monster) {
                // Reuse the existing monster details function
                showMonsterDetails(monster.name);
            } else {
                showCustomAlert(`Monster details not found for ${entryName}. This might be a custom entry or the monster was removed from the encounter.`);
            }
        }

        // Scroll to current turn creature
        function scrollToCurrentTurn() {
            if (!combatActive || initiativeEntries.length === 0) return;
            
            // Find all initiative entry elements
            const initiativeRows = document.querySelectorAll('#initiativeList > div');
            
            // The current turn is at the currentTurnIndex after sorting
            if (currentTurnIndex < initiativeRows.length) {
                const currentRow = initiativeRows[currentTurnIndex];
                
                // Scroll the element into view, centered in the viewport
                if (currentRow) {
                    currentRow.scrollIntoView({
                        behavior: 'smooth',
                        block: 'center',
                        inline: 'nearest'
                    });
                }
            }
        }

        // Stats Modal for editing Evasion and Threshold
        function openStatsModal(entryId) {
            const entry = initiativeEntries.find(e => e.id === entryId);
            if (!entry) return;
            
            // Parse threshold values
            const thresholdParts = entry.threshold.split('|');
            const thresholdLow = parseInt(thresholdParts[0]) || 0;
            const thresholdHigh = parseInt(thresholdParts[1]) || 0;
            
            // Create modal
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Edit Stats for ${entry.name}</h3>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Evasion</label>
                            <input type="number" id="modal-evasion" value="${entry.evasion}" min="1" max="30" 
                                   class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Threshold Lower</label>
                                <input type="number" id="modal-threshold-low" value="${thresholdLow}" min="1" max="50" 
                                       class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Threshold Upper</label>
                                <input type="number" id="modal-threshold-high" value="${thresholdHigh}" min="2" max="100" 
                                       class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-base">
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button id="cancel-stats" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">Cancel</button>
                        <button id="confirm-stats" class="px-4 py-2 bg-primary text-white hover:bg-primary-dark rounded transition-colors">Confirm</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Focus on first input
            document.getElementById('modal-evasion').focus();
            
            // Add event listeners
            document.getElementById('cancel-stats').addEventListener('click', () => {
                modal.remove();
            });
            
            document.getElementById('confirm-stats').addEventListener('click', () => {
                // Get new values
                const newEvasion = parseInt(document.getElementById('modal-evasion').value) || entry.evasion;
                const newThresholdLow = parseInt(document.getElementById('modal-threshold-low').value) || thresholdLow;
                const newThresholdHigh = parseInt(document.getElementById('modal-threshold-high').value) || thresholdHigh;
                
                // Validate threshold values
                if (newThresholdHigh <= newThresholdLow) {
                    showCustomAlert('Threshold Upper must be greater than Threshold Lower!');
                    return;
                }
                
                // Update entry
                entry.evasion = newEvasion;
                entry.threshold = `${newThresholdLow}|${newThresholdHigh}`;
                
                // Close modal and re-render
                modal.remove();
                renderInitiativeList();
            });
            
            // Allow Enter key to confirm
            modal.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    document.getElementById('confirm-stats').click();
                } else if (e.key === 'Escape') {
                    document.getElementById('cancel-stats').click();
                }
            });
        }

        // Saved encounter management
        function saveCurrentEncounter() {
            const encounterName = document.getElementById('encounter-name').value.trim();
            
            if (!encounterName) {
                showCustomAlert('Please enter an encounter name!');
                return;
            }
            
            if (encounter.length === 0) {
                showCustomAlert('Please add monsters to the encounter first!');
                return;
            }
            
            // Get existing saved encounters
            const savedEncounters = JSON.parse(localStorage.getItem('encounterBalancer_savedEncounters') || '{}');
            
            // Save the current encounter
            savedEncounters[encounterName] = {
                name: encounterName,
                monsters: [...encounter],
                savedDate: new Date().toISOString()
            };
            
            // Store back to localStorage
            localStorage.setItem('encounterBalancer_savedEncounters', JSON.stringify(savedEncounters));
            
            // Clear the input and update dropdown
            document.getElementById('encounter-name').value = '';
            updateSavedEncountersDropdown();
            
            showCustomAlert(`Encounter "${encounterName}" saved successfully!`);
        }

        function loadSavedEncounter() {
            const selectedEncounterName = document.getElementById('saved-encounters').value;
            
            if (!selectedEncounterName) {
                showCustomAlert('Please select a saved encounter first!');
                return;
            }
            
            // Get saved encounters from localStorage
            const savedEncounters = JSON.parse(localStorage.getItem('encounterBalancer_savedEncounters') || '{}');
            const savedEncounter = savedEncounters[selectedEncounterName];
            
            if (!savedEncounter) {
                showCustomAlert('Saved encounter not found!');
                return;
            }
            
            // Load the encounter data
            encounter = [...savedEncounter.monsters];
            
            // Re-render the encounter and update summary
            renderCurrentEncounter();
            updateEncounterSummary();
            
            showCustomAlert(`Encounter "${selectedEncounterName}" loaded successfully!`);
        }

        function updateSavedEncountersDropdown() {
            const dropdown = document.getElementById('saved-encounters');
            const savedEncounters = JSON.parse(localStorage.getItem('encounterBalancer_savedEncounters') || '{}');
            
            // Clear existing options except the first one
            dropdown.innerHTML = '<option value="">Select saved encounter...</option>';
            
            // Add saved encounters to dropdown
            Object.keys(savedEncounters).sort().forEach(encounterName => {
                const option = document.createElement('option');
                option.value = encounterName;
                const encounter = savedEncounters[encounterName];
                const savedDate = new Date(encounter.savedDate).toLocaleDateString();
                const totalMonsters = encounter.monsters.reduce((sum, entry) => sum + entry.quantity, 0);
                option.textContent = `${encounterName} (${totalMonsters} monsters - ${savedDate})`;
                dropdown.appendChild(option);
            });
        }

        function deleteSavedEncounter() {
            const selectedEncounterName = document.getElementById('saved-encounters').value;
            
            if (!selectedEncounterName) {
                showCustomAlert('Please select a saved encounter to delete!');
                return;
            }
            
            // Show confirmation modal
            showDeleteEncounterConfirmDialog(selectedEncounterName);
        }

        // Custom confirmation dialog for encounter deletion
        function showDeleteEncounterConfirmDialog(encounterName) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-md w-full mx-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Confirm Deletion</h3>
                    <p class="text-gray-700 dark:text-gray-300 mb-6">Are you sure you want to delete the encounter "${encounterName}"? This action cannot be undone.</p>
                    <div class="flex justify-end space-x-3">
                        <button id="cancel-delete-encounter" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700 rounded transition-colors">Cancel</button>
                        <button id="confirm-delete-encounter" class="px-4 py-2 bg-red-500 text-white hover:bg-red-600 rounded transition-colors">Delete</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Add event listeners
            document.getElementById('cancel-delete-encounter').addEventListener('click', () => {
                modal.remove();
            });
            
            document.getElementById('confirm-delete-encounter').addEventListener('click', () => {
                // User confirmed deletion
                const savedEncounters = JSON.parse(localStorage.getItem('encounterBalancer_savedEncounters') || '{}');
                delete savedEncounters[encounterName];
                localStorage.setItem('encounterBalancer_savedEncounters', JSON.stringify(savedEncounters));
                
                // Update dropdown and clear selection
                updateSavedEncountersDropdown();
                document.getElementById('saved-encounters').value = '';
                
                // Close modal and show success message
                modal.remove();
                showCustomAlert(`Encounter "${encounterName}" deleted successfully!`);
            });
        }

        // Initialize
        updatePartySize();
        updateMonsterGuidelines();
        filterMonsters();
        filterBuilderMonsters();
        updateEncounterSummary();
        updateSavedPartiesDropdown(); // Load saved parties on startup
        updateSavedEncountersDropdown(); // Load saved encounters on startup
    </script>
</body>
</html>
